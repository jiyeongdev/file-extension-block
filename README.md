# 파일 확장자 차단 시스템

보안상 위험한 파일 확장자를 차단하고 관리하는 Spring Boot 애플리케이션입니다.

## 주요 기능

- **고정 확장자 관리**: exe, sh, cmd 등 위험한 확장자 차단
- **커스텀 확장자 관리**: 사용자 정의 확장자 추가/삭제
- **파일 업로드**: 안전한 파일 업로드 및 관리


## 기술 스택

- **Backend**: Spring Boot 3.x, Java 21
- **Database**: H2 Database (개발용)
- **Build Tool**: Gradle
- **Template Engine**: Thymeleaf, JSP
- **Query Builder**: QueryDSL 5.0 (타입 안전한 쿼리 작성)

## 프로젝트 구조

```
src/main/java/com/fileextension/proj/
├── config/          # 설정 클래스
├── controller/      # 컨트롤러
├── dto/            # 데이터 전송 객체
├── entity/         # 엔티티
├── repository/     # 리포지토리 (JPA + QueryDSL)
├── service/        # 서비스 계층
└── ProjApplication.java
```

## 디렉토리 구조

```
file-extension-proj/
├── src/                    # 소스 코드
├── build/generated/        # QueryDSL Q클래스 생성 디렉토리
├── data/                   # H2 데이터베이스 파일 (로컬)
├── uploads/                # 파일 업로드 디렉토리 (로컬)
├── logs/                   # 로그 파일 (운영)
├── Dockerfile              # 도커 이미지 빌드
├── docker-compose.yml      # 도커 컴포즈 설정
└── README.md
```

### 3. 접속

- **애플리케이션**:  https://www.fridgepal.life/

## 환경별 설정

### 프로파일

- **local**: 로컬 개발 환경 (H2 Database)
- **prod**: 운영 환경 (실제 데이터베이스)

### 설정 파일

- `application.yml`: 공통 설정
- `application-local.yml`: 로컬 환경 설정
- `application-prod.yml`: 운영 환경 설정

### 환경별 디렉토리 설정

| 환경 | 업로드 디렉토리 | 데이터베이스 | 로그 |
|------|----------------|-------------|------|
| local | `${user.dir}/uploads` | `./data/testdb` | 콘솔 |
| prod | `/app/uploads` | 외부 DB | `/app/logs` |

## API 엔드포인트

### 확장자 관리

- `GET /api/extensions/fixed`: 고정 확장자 목록 조회
- `GET /api/extensions/custom`: 커스텀 확장자 목록 조회
- `POST /api/extensions/custom`: 커스텀 확장자 추가
- `DELETE /api/extensions/custom/{id}`: 커스텀 확장자 삭제

### 파일 업로드

- `POST /api/files/upload`: 파일 업로드
- `GET /api/files`: 업로드된 파일 목록 조회
- `DELETE /api/files/{filename}`: 파일 삭제

## 보안 고려사항

⚠️ **중요**: 이 시스템은 다층 보안을 통해 파일 업로드 공격을 효과적으로 차단합니다.

### 구현된 보안 기능

#### 1. **확장자 기반 차단**
- 고정 확장자 차단: exe, bat, cmd, com, cpl, scr, js 등
- 커스텀 확장자 차단: 사용자가 추가한 확장자
- 사용자 제어: 원하는 확장자만 선택적으로 차단 가능

#### 2. **확장자 우회 방지 (파일명 기반)**
- **차단 예시**: `memo.exe.txt`, `script.bat.jpg`, `virus.cmd.txt`
- **동작 원리**: 마지막 점 이후만 확장자로 인식, 파일명에 차단된 확장자 포함 시 차단
- **보안 효과**: 공격자가 실행 파일을 안전한 확장자로 위장하는 공격 방지

#### 3. **파일 내용 검증 (매직 바이트)**
- **매직 바이트 검증**: 파일 내용의 실제 형식을 확인
- **차단 예시**: 
  - `document.txt`로 이름을 바꾼 실행 파일 (매직 바이트: PE 헤더)
  - `image.jpg`로 이름을 바꾼 바이너리 파일 (매직 바이트: PE 헤더)
  - `script.txt`로 이름을 바꾼 ELF 파일 (매직 바이트: ELF 헤더)
  - `memo.txt`로 이름을 바꾼 쉘 스크립트 (매직 바이트: #! 헤더)

#### 4. **다중 확장자 검사**
- 파일명에 포함된 모든 확장자 검사
- 사용자 설정 기반: 차단된 확장자만 검사 대상

### 보안 공격 시나리오 및 방어

#### 공격 시나리오 1: 확장자 우회
```
공격자: virus.exe → memo.exe.txt로 이름 변경
시스템: 파일명에 exe 포함 → 차단됨
결과: 확장자 우회 공격 실패
```

#### 공격 시나리오 2: 파일 내용 조작
```
공격자: virus.exe를 document.txt로 이름 변경
시스템: 매직 바이트 검증 → PE 헤더 감지
결과: 파일 내용 조작 공격 실패
```

#### 공격 시나리오 3: 매직 바이트 우회
```
공격자: 실행 파일을 안전한 확장자로 이름 변경
시스템: 매직 바이트 검증 → PE/ELF/Mach-O 헤더 감지
결과: 파일 내용 기반 공격 실패
```

## 🛡️ 고급 보안 기능

### 확장자 우회 공격 방지 시스템

#### 지원하는 파일 형식 감지

| 카테고리 | 파일 형식 | 감지 방식 | 매직 바이트 |
|----------|-----------|-----------|-------------|
| **실행 파일** | EXE, SCR, CPL, COM | PE 헤더 | `4D 5A` (MZ) |
| **스크립트** | BAT, CMD, JS | 내용 분석 | 텍스트 패턴 |
| **문서** | PDF | PDF 시그니처 | `25 50 44 46` (%PDF) |
| **압축** | ZIP, DOCX, XLSX | ZIP 시그니처 | `50 4B` (PK) |
| **이미지** | JPG, PNG, GIF | 이미지 헤더 | 각각 고유 시그니처 |
| **텍스트** | TXT | 텍스트 검증 | ASCII/UTF-8 검증 |

### 실제 우회 공격 테스트 결과

#### 테스트 시나리오 및 결과

| 테스트 케이스 | 파일명 | 확장자 | 매직 바이트 | 결과 | 보안 효과 |
|---------------|--------|--------|-------------|------|-----------|
| **정상 EXE** | `real_pe.exe` | `exe` | `exe` | ❌ 차단 | 확장자 기반 차단 |
| **우회 공격 1** | `virus.txt` | `txt` | `exe` | ❌ 차단 | 확장자 우회 감지 |
| **우회 공격 2** | `document.pdf` | `pdf` | `exe` | ❌ 차단 | 확장자 우회 감지 |
| **우회 공격 3** | `safe.txt` | `txt` | `exe` | ❌ 차단 | 확장자 우회 감지 |
| **정상 텍스트** | `normal.txt` | `txt` | `txt` | ✅ 허용 | 정상 파일 보호 |
| **사용자 설정** | `screensaver.scr` | `scr` | `exe` | ✅ 허용 | 사용자 설정 존중 |

#### 공격 시나리오별 방어 메커니즘

| 공격 유형 | 공격 방법 | 시스템 대응 | 결과 |
|-----------|-----------|-------------|------|
| **확장자 우회** | `virus.exe` → `document.txt` | 매직 바이트 검증 | ❌ 차단됨 |
| **다중 확장자** | `virus.exe.txt` | 파일명 전체 검사 | ❌ 차단됨 |
| **MIME 타입 조작** | Content-Type 조작 | 매직 바이트 우선 | ❌ 차단됨 |
| **정상 파일 위장** | 실제 텍스트 파일 | 내용 검증 | ✅ 허용됨 |

### 사용자 설정 기반 보안

#### 설정 시나리오 예시

| 사용자 설정 | 파일 업로드 | 시스템 동작 | 결과 |
|-------------|-------------|-------------|------|
| EXE 차단, SCR 허용 | `virus.exe` | 확장자 기반 차단 | ❌ 차단 |
| EXE 차단, SCR 허용 | `screensaver.scr` | 확장자 기반 허용 | ✅ 허용 |
| EXE 차단, SCR 허용 | `virus.exe` → `screensaver.scr` | 확장자 우선 (사용자 설정 존중) | ✅ 허용 |
| BAT 차단, JS 허용 | `script.bat` | 확장자 기반 차단 | ❌ 차단 |
| BAT 차단, JS 허용 | `script.js` | 확장자 기반 허용 | ✅ 허용 |

## 🔧 예외처리 및 안정성

### 파일 업로드 예외처리

#### 1. **중복 파일명 처리**

**결과**: `document.pdf` 같은 동일한 파일명+확장자 파일 업로드 시 -1 , -2 .. 이 붙음 → `document-1.pdf` → `document-2.pdf`

#### 2. **파일 형식 검증**
- 빈 파일 업로드 방지
- 지원하지 않는 파일 형식 차단
- 파일명 특수문자 처리

### 데이터베이스 예외처리

#### 1. **중복 확장자 처리**

- 고정 확장자에 이미 존재하는 확장자인 경우 , 커스텀 확장자에 추가되지 않는다.

#### 2. **데이터 무결성 보장**
- 확장자명 정규화 (소문자, 공백 제거)
- 최대 길이 제한
- 특수문자 필터링

